<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Learning Walk Notes</title>
<meta name="theme-color" content="#0ea5e9" />
<style>
:root{--bg:#f7f7fb;--card:#ffffff;--ink:#0b1220;--muted:#6b7280;--brand:#0ea5e9;--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
.wrap{max-width:960px;margin:0 auto;padding:20px}
.card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(2,8,20,.06);padding:18px;margin-bottom:14px}
h1{font-size:1.4rem;margin:4px 0 14px}
.row{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:800px){.row.two{grid-template-columns:1fr 1fr}.row.three{grid-template-columns:repeat(3,1fr)}}
label{font-size:.9rem;color:var(--muted);margin-bottom:6px;display:block}
input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;font-size:1rem}
textarea{min-height:120px}
.btn{background:var(--brand);color:white;padding:12px;border-radius:12px;font-weight:600;text-decoration:none;cursor:pointer;border:none;display:inline-block;margin-right:6px;margin-top:6px}
.btn.secondary{background:#e9e9ec;color:#111}
.btn.warn{background:var(--warn)}
.btn.success{background:var(--ok)}
table{width:100%;border-spacing:0 8px}
td,th{padding:10px;background:#fff;border:1px solid #eee;border-radius:8px;font-size:.9rem}
ul{padding-left:0;margin:6px 0}
ul li{list-style:none;margin-bottom:6px}
.small{font-size:.85rem;color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
<h1>Learning Walk — Quick Notes</h1>

<div class="card">
<div class="row three">
<div><label>Date & Time</label><input type="datetime-local" id="dt" /></div>
<div><label>Year Group</label>
<select id="year"><option>Y7</option><option>Y8</option><option>Y9</option><option>Y10</option><option selected>Y11</option></select>
</div>
<div><label>Teacher</label><input id="teacher" /></div>
</div>

<div class="row three">
<div><label>Subject</label><input id="subject" /></div>
<div><label>Class / Set</label><input id="classSet" /></div>
<div><label>Room</label><input id="room" /></div>
</div>

<div class="row three">
<div><label>Period</label><input id="period"></div>
<div><label>Behaviour (1–5)</label><input id="behaviour" type="number" min="1" max="5"></div>
<div><label>Engagement (1–5)</label><input id="engagement" type="number" min="1" max="5"></div>
</div>

<label>Quick ticks</label>
<ul>
<li><label><input type="checkbox" id="tick_lo"> LO visible</label></li>
<li><label><input type="checkbox" id="tick_retrieval"> Retrieval starter</label></li>
<li><label><input type="checkbox" id="tick_questioning"> Effective questioning</label></li>
<li><label><input type="checkbox" id="tick_afl"> AFL checks</label></li>
<li><label><input type="checkbox" id="tick_send"> SEND scaffolds</label></li>
<li><label><input type="checkbox" id="tick_literacy"> Literacy focus</label></li>
<li><label><input type="checkbox" id="tick_homework"> Homework set</label></li>
<li><label><input type="checkbox" id="tick_routines"> Strong routines</label></li>
</ul>

<label>Observation Notes</label><textarea id="notes"></textarea>
<label>Strengths</label><textarea id="strengths"></textarea>
<label>Areas for Development</label><textarea id="areas"></textarea>
<label>Actions / Next Steps</label><textarea id="actions"></textarea>

<label>Send to (Outlook)</label><input id="email" placeholder="name@school.org">

<div class="small">If the Outlook button doesn't open, your phone may not be set to handle mail links. This button now tries Outlook first, then mail, then Share.</div>
<button class="btn success" id="saveEntryBtn">Save entry</button>
<button class="btn secondary" id="newEntryBtn">New</button>
<button class="btn" id="copyBtn">Copy</button>
<button class="btn warn" id="clearBtn">Clear</button>
<a class="btn" id="mailtoBtn">Email</a>
</div>

<div class="card">
<input id="search" placeholder="Search..." style="width:100%;padding:8px;margin-bottom:8px">
<button class="btn secondary" id="exportCsvBtn">Export CSV</button>
<table>
<thead><tr><th>Date</th><th>Teacher</th><th>Actions</th></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
const $=id=>document.getElementById(id);
const fields=['dt','year','teacher','subject','classSet','room','period','behaviour','engagement','notes','strengths','areas','actions','email','tick_lo','tick_retrieval','tick_questioning','tick_afl','tick_send','tick_literacy','tick_homework','tick_routines'];
let CURRENT_ID=null;

function load(){try{let f=JSON.parse(localStorage.form||"{}");fields.forEach(k=>{let el=$(k);if(el){if(el.type=="checkbox")el.checked=!!f[k];else if(f[k])el.value=f[k];}});}catch{} if(!$('dt').value)$('dt').value=new Date().toISOString().slice(0,16);}
function saveSnap(){let f={};fields.forEach(k=>{let el=$(k);if(el)f[k]=(el.type=="checkbox"?el.checked:el.value)});localStorage.form=JSON.stringify(f);return f;}
function entry(){let f=saveSnap();return{id:CURRENT_ID||("e"+Date.now()),...f};}
function list(){return JSON.parse(localStorage.list||"[]");}
function store(a){localStorage.list=JSON.stringify(a);}
function render(){let q=$('search').value.toLowerCase();let a=list().filter(e=>(e.teacher||'').toLowerCase().includes(q)||(e.subject||'').toLowerCase().includes(q)||(e.notes||'').toLowerCase().includes(q));$('tbody').innerHTML=a.map(e=>`<tr><td>${e.dt||""}</td><td>${e.teacher||""}</td><td><button onclick='edit("${e.id}")'>View</button> <button onclick='del("${e.id}")'>X</button></td></tr>`).join("");}
function edit(id){let e=list().find(x=>x.id==id);CURRENT_ID=id;fields.forEach(k=>{let el=$(k);if(el){if(el.type=="checkbox")el.checked=!!e[k];else el.value=e[k]||"";}});saveSnap();window.scrollTo(0,0);}
function del(id){store(list().filter(x=>x.id!=id));render();}

$('saveEntryBtn').onclick=()=>{let e=entry(),a=list();let i=a.findIndex(x=>x.id==e.id);if(i>=0)a[i]=e;else a.unshift(e);store(a);alert("Saved");render();};
$('newEntryBtn').onclick=()=>{CURRENT_ID=null;localStorage.removeItem("form");location.reload()};
$('clearBtn').onclick=()=>{if(confirm("Clear?")){CURRENT_ID=null;localStorage.removeItem("form");location.reload()}};
$('copyBtn').onclick=()=>{navigator.clipboard.writeText(JSON.stringify(entry(),null,2));alert("Copied")};
$('search').oninput=render;
$('exportCsvBtn').onclick=()=>{let csv="";let a=list();a.forEach(e=>{csv+=Object.values(e).map(v=>`"${String(v).replaceAll('"','""')}"`).join(",") + "\n"});let b=new Blob([csv]);let u=URL.createObjectURL(b);let d=document.createElement("a");d.href=u;d.download="walks.csv";d.click()};

// ---- Robust email button: Outlook deep link -> mailto -> Share fallback
$('mailtoBtn').onclick=async ()=>{
  const e=entry();
  const subj = `Learning Walk – ${e.year||''} – ${e.teacher||''} – ${e.subject||''}`.trim();
  const body = [
    `Date/Time: ${e.dt||''}`,
    `Year: ${e.year||''}`,
    `Teacher: ${e.teacher||''}`,
    `Subject: ${e.subject||''}`,
    `Class/Set: ${e.classSet||''}`,
    `Room: ${e.room||''}`,
    `Period: ${e.period||''}`,
    `Behaviour: ${e.behaviour||''} /5`,
    `Engagement: ${e.engagement||''} /5`,
    '',
    'Observation Notes:',
    e.notes||'-',
    '',
    'Strengths:',
    e.strengths||'-',
    '',
    'Areas for Development:',
    e.areas||'-',
    '',
    'Actions / Next Steps:',
    e.actions||'-'
  ].join('\n');

  const to = e.email||'';
  const outlook = `ms-outlook://compose?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  const mailto  = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;

  // Try Outlook deep link first
  let triedMailto = false;
  const t = setTimeout(()=>{
    // Fallback to mailto after 700ms if Outlook not handled
    triedMailto = true;
    window.location.href = mailto;
    // Final fallback: Share sheet after another delay
    setTimeout(async ()=>{
      if (navigator.share){
        try{ await navigator.share({title: subj, text: body}); }catch{}
      }else{
        try{ await navigator.clipboard.writeText(body); alert('Email body copied. Open Outlook and paste.'); }catch{ alert('Copy failed.'); }
      }
    }, 800);
  }, 700);

  window.location.href = outlook;
};
load();render();
</script>

</body>
</html>